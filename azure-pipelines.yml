trigger:
- master

pool:
  vmImage: ubuntu-latest
  
steps:
- task: Docker@2
  displayName: 'Build NodeJS Image'
  inputs:
    command: 'build'
    Dockerfile: '**/Dockerfile'
    arguments: '-t appimage1:latest'
    
#- task: trivy@1
#  inputs:
#    version: 'latest'
#    image: 'appimage1'
#    exitCode: '0'

- script: |
    curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b ./trivy
  displayName: 'Install Trivy'
 
- script: |
    ./trivy/trivy image --format sarif -o trivy-results.sarif appimage1:latest
  displayName: 'Scan Docker Image with Trivy'


- task: PublishPipelineArtifact@1
  inputs:
    targetPath: '$(Pipeline.Workspace)'
    artifact: 'trivy-results.sarif'
    publishLocation: 'pipeline'